name: main
on: push

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - run: echo build
  terraform:
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        working-directory: terraform
    steps:
      - uses: actions/checkout@v3 # https://github.com/actions/checkout/releases
      - uses: actions/setup-python@v4 # https://github.com/actions/setup-python/tags
        with:
          python-version: '3.11' # https://github.com/python/cpython/tags
      - uses: hashicorp/setup-terraform@v2 # https://github.com/hashicorp/setup-terraform/tags
        with:
          terraform_version: 1.3.6 # https://github.com/hashicorp/terraform/tags
          terraform_wrapper: false
      - uses: aws-actions/configure-aws-credentials@v1-node16 # https://github.com/aws-actions/configure-aws-credentials/tags
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/${{ vars.AWS_ROLE_NAME }}
          aws-region: ${{ vars.AWS_DEFAULT_REGION }}
      - uses: champ-oss/action-terraform-config@v1.0.1-9188739 # https://github.com/champ-oss/action-terraform-config/tags
      - run: terraform init
      - run: terraform validate
      - run: terraform plan -out=terraform.tfplan
      - run: terraform apply -auto-approve terraform.tfplan
      - run: terraform plan -detailed-exitcode
  test:
    runs-on: ubuntu-latest
    needs: terraform
    steps:
      - run: echo test
